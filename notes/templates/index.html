<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Collaborative Notes</title>

    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #f4f6f8;
            display: flex;
            justify-content: center;
            padding-top: 40px;
        }

        .container {
            background: white;
            width: 700px;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-bottom: 10px;
        }

        .meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        textarea {
            height: 240px;
            resize: none;
        }

        button {
            margin-top: 15px;
            padding: 10px 16px;
            border-radius: 6px;
            border: none;
            background: #4f46e5;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        #typing {
            margin-top: 8px;
            font-size: 14px;
            color: #16a34a;
        }

        #status {
            margin-top: 10px;
            font-size: 13px;
            color: #555;
        }

        /* Hide note fields by default */
        #noteFields {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>üìù Collaborative Notes</h2>

        <div class="meta">
            Note ID: <span id="noteIdText"></span>
        </div>

        <label>JWT Token</label>
        <input type="text" id="token" placeholder="Paste JWT access token">

        <button id="connectBtn" onclick="connectWS()">Connect</button>
        <div id="status"></div>

        <!-- Wrapped note fields in a div for easy hide/show -->
        <div id="noteFields">
            <label>Title</label>
            <input type="text" id="title" disabled>

            <label>Content</label>
            <textarea id="content" placeholder="Start typing..." disabled></textarea>

            <button id="saveBtn" onclick="saveNote()" disabled>üíæ Save</button>
        </div>

        <div id="typing"></div>
    </div>

    <script>
        let ws;
        let typingClearTimer = null;
        let lastTypingSent = 0;

        const statusEl = document.getElementById("status");
        const connectBtn = document.getElementById("connectBtn");
        const saveBtn = document.getElementById("saveBtn");

        const noteFields = document.getElementById("noteFields");
        const titleEl = document.getElementById("title");
        const contentEl = document.getElementById("content");

        function getNoteIdFromURL() {
            const parts = window.location.pathname.split("/").filter(Boolean);
            return parts[parts.length - 1];
        }

        const noteId = getNoteIdFromURL();
        document.getElementById("noteIdText").innerText = noteId;

        function connectWS() {
            const token = document.getElementById("token").value.trim();
            if (!token) {
                alert("JWT token required");
                return;
            }

            ws = new WebSocket(
                `ws://127.0.0.1:8001/ws/notes/${noteId}/?token=${token}`
            );

            ws.onopen = () => {
                statusEl.innerText = "‚úÖ Connected";
                connectBtn.disabled = true;

                // Fetch note to check access
                fetch(`/api/notes/${noteId}/`, {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(err => { throw err; });
                    }
                    return res.json();
                })
                .then(data => {
                    // Show note fields only if accessible
                    noteFields.style.display = "block";
                    titleEl.disabled = false;
                    contentEl.disabled = false;
                    saveBtn.disabled = false;

                    titleEl.value = data.title || "";
                    contentEl.value = data.content || "";
                })
                .catch(err => {
                    console.error("Fetch note error:", err);
                    statusEl.innerText = "‚ùå Access denied or note not found";
                    // Keep note fields hidden
                    noteFields.style.display = "none";
                });
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "typing") {
                    const others = data.users.filter(
                        u => u !== data.current_user
                    );
                    document.getElementById("typing").innerText =
                        others.length ? `${others.join(", ")} is typing...` : "";

                    clearTimeout(typingClearTimer);
                    typingClearTimer = setTimeout(() => {
                        document.getElementById("typing").innerText = "";
                    }, 3000);
                }

                // Note updates
                if (data.type === "note_update") {
                    const note = data.data || {};
                    if (note.title !== undefined) titleEl.value = note.title;
                    if (note.content !== undefined) contentEl.value = note.content;
                }
            };

            ws.onclose = () => {
                statusEl.innerText = "‚ùå Disconnected";
                connectBtn.disabled = false;
                saveBtn.disabled = true;
                titleEl.disabled = true;
                contentEl.disabled = true;
            };
        }

        // Typing indicator
        contentEl.addEventListener("input", () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            const now = Date.now();
            if (now - lastTypingSent > 800) {
                ws.send(JSON.stringify({ type: "typing" }));
                lastTypingSent = now;
            }
        });

        function saveNote() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert("WebSocket not connected");
                return;
            }

            const token = document.getElementById("token").value.trim();

            const payload = {
                title: titleEl.value,
                content: contentEl.value
            };

            fetch(`/api/notes/${noteId}/`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(err => {
                            console.error("PATCH error:", err);
                            throw err;
                        });
                    }
                    return res.json();
                })
                .then(() => {
                    statusEl.innerText = "‚úÖ Saved";
                    setTimeout(() => {
                        statusEl.innerText = "‚úÖ Connected";
                    }, 1500);
                })
                .catch(() => alert("Failed to save note"));
        }
    </script>

</body>

</html>
